name: Appium Run CI

on:
  push:
    branches: [ "lp/apredendendo-CI/CD" ]
  pull_request:
    branches: [ "lp/apredendendo-CI/CD" ]

jobs:
    appium_test:
        runs-on: ubuntu-latest

        steps:

        - name: Checkout
          uses: actions/checkout@v3

        - name: Configurar Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '18.0.0'
            cache: 'npm'

        - name: Set up JDK
          uses: actions/setup-java@v2
          with:
              distribution: 'adopt'
              java-version: '11'

        - name: Instalar dependências do projeto
          run: npm install

        - name: Setup Android SDK
          uses: android-actions/setup-android@v3

        - name: Iniciar Appium Server
          run: chmod +x ./scripts/appium-server.sh && ./scripts/appium-server.sh

        - name: Esperar Appium Server
          run: |
            until nc -z localhost 4723; do
            sleep 1
            done

        - name: Configuração do Emulador
          run: chmod +x ./scripts/emulator.sh && ./scripts/emulator.sh

        - name: Esperar pelo Emulador
          run: adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'

        - name: Executar Testes
          run: npm test:all
